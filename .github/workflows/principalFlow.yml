# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: CHECKOUT CURRENT REPOSITORY IN VIRTUAL MACHINE
        uses: actions/checkout@v3
          
      - name: NODE INSTALL
        run: npm install node
          
      - name: INSTALL SFDX 
        run: npm install @salesforce/cli --global 
      
      - name: AUTH DEV HUB
        run: sf org login jwt --client-id 3MVG9si4IYYQbK9f7D.leWPJNFUvjLZy8eTs9FVP_n4DFhdfr289th0g5PR6deLnsoyFpbNzccgcmgJpNMw4h --jwt-key-file server.key --username nicholas@arpedio.com --alias devHub --set-default-dev-hub  
      
      - name: CREATE SCRATCH
        id: create-scratch
        run: |
          output=$(sf org create scratch --definition-file config/project-scratch-def.json --alias TestDeployScratch --duration-days 1 --set-default --json | base64 -w 0)
          echo "::set-output name=result::${output}"

      - name: Save JSON Result
        run: |
          echo "${{ steps.create-scratch.outputs.result }}" > result.json

      - name: Add or update secret
        run: |
            gh secret set SCRATC_ORG_AUTH --body=$(cat "result.json")
        env:
          GH_TOKEN: ${{ secrets.ADMIN_TOKEN }}
    
      - name: install jq
        run: |
          sudo apt-get install jq
      - name : decode secret
        run: |
          export DECODED_SECRET=$(echo "${{ secrets.SCRATC_ORG_AUTH }}" |  base64 --decode)
          PRIVATE_KEY=$(echo "$DECODED_SECRET" | jq -r '.result.authFields.privateKey')
          echo "authFields.privateKey is: $PRIVATE_KEY"
        shell: bash
      - name: store key as secret
        run: |
          gh secret set SCRATC_ORG_KEY --body=$(cat PRIVATE_KEY)
        env:
          GH_TOKEN: ${{ secrets.ADMIN_TOKEN }}          
      
      - name: echo key
        run: |
          export KEY_SECRET=$(echo "${{ secrets.SCRATC_ORG_KEY }}")
          echo "OUR KEY  is: $KEY_SECRET"

      
