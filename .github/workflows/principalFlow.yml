name: CI

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: CHECKOUT CURRENT REPOSITORY IN VIRTUAL MACHINE
        uses: actions/checkout@v3
          
      - name: NODE INSTALL
        run: npm install node

      - name: Set up GitHub CLI
        uses: actions/setup-python@v2
        with:
          python-version: "3.x"

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install gh 

      - name: install jq
        run: |
            sudo apt-get install jq
          
      - name: INSTALL SFDX 
        run: npm install @salesforce/cli --global 
      
      - name: AUTH DEV HUB
        run: |
            echo "${{ secrets.DEVHUB_KEY }}" > devhubkey.key
            CLIENT_ID=${{ secrets.DEVHUB_CLIENTID}}
            sf org login jwt --client-id $CLIENT_ID --jwt-key-file devhubkey.key --username nicholas@arpedio.com --alias devHub --set-default-dev-hub  

      - name: Authorize Scratch Org, Create Scratch, Save JSON Result, Add or update secret
        id: scratch-and-secret
        env:
          GH_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        run: |
            # Check if Scratch Org exists
            USERNAME=$(echo "${{ secrets.SCRATC_ORG_AUTH }}" | base64 --decode | jq -r '.result.authFields.username')
            SCRATCH_EXISTS=$(sf org list --json | jq -r ".result.scratchOrgs[] | select(.username==\"$USERNAME\") | .username")
            if [ -z "$SCRATCH_EXISTS" ]; then
                echo "No existing scratch org found. Creating a new one."
                # Create Scratch Org
                output=$(sf org create scratch --definition-file config/project-scratch-def.json --alias TestDeployScratch --duration-days 10 --set-default --json | base64 -w 0)
                echo "::set-output name=result::${output}"
                SCRATCH_ORG_ID=$(echo "$DECODED_SECRET" | jq -r '.result.scratchOrgInfo.scratchOrg')
                echo "Scratch Org ID is: $SCRATCH_ORG_ID"
      
                # Save JSON Result
                echo "${output}" > result.json
      
                # Add or update secret
                gh secret set SCRATC_ORG_AUTH --body=$(cat "result.json")
            else
                echo "Existing scratch org found. Authenticating to it."
                export DECODED_SECRET=$(echo "${{ secrets.SCRATC_ORG_AUTH }}" | base64 --decode)
                echo "decoded secret is: $DECODED_SECRET"
                SCRATCH_ORG_ID=$(echo "$DECODED_SECRET" | jq -r '.result.scratchOrgInfo.scratchOrg')
                echo "Scratch Org ID is: $SCRATCH_ORG_ID"
                CONSUMER_KEY=$(echo "$DECODED_SECRET" | jq -r '.result.scratchOrgInfo.ConnectedAppConsumerKey')
                echo "Consumer key is: $CONSUMER_KEY"
                INSTANCE_URL=$(echo "$DECODED_SECRET" | jq -r '.result.authFields.instanceUrl')
                echo "Instance Url is: $INSTANCE_URL + ' ' + succesfully authorised scratch org"
                echo "${{ secrets.DEVHUB_KEY }}" > devhubkey.key
                sf org login jwt --client-id $CONSUMER_KEY --jwt-key-file devhubkey.key --username $USERNAME --instanceurl $INSTANCE_URL --set-default --json
            fi


      - name: try DEPLOY and execute tests
        run: sf project deploy start --dry-run  --test-level RunAllTestsInOrg
